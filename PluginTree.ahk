;;; TODO make subfolder manifests use recursion and create a folder per sub-subfolder instead of one master manifest per module.

#Requires AutoHotkey v2.0
#SingleInstance Force
; #Warn All, MsgBox


GenPluginTree(PluginDir) {
  OldDir := A_WorkingDir
  SetWorkingDir PluginDir
  Loop Files, "*", "D" {
  If SubStr(A_LoopFileName, 1, 1) != "_"
    GenManifest(A_LoopFilePath)
  }
  GenTopManifest(PluginDir)
  SetWorkingDir OldDir
}
GenManifest(Dir, Filename := "") {
  Filename := DirToManifest(Dir, Filename)
  OldDir := A_WorkingDir
  SetWorkingDir Dir

  contents := ""
  Loop Files, "*.ahk", "R" {
    If SubStr(A_LoopFileName, 1, 1) != "_" {
      if A_LoopFilePath != Filename
        contents .= "#include " . A_LoopFilePath "`n"
    }
  }

  SetWorkingDir OldDir
  WriteAutoGen(Dir, Filename, contents)
}

GenTopManifest(Dir, FileName := "") {
  FileName := DirToManifest(Dir, FileName)
  OldDir := A_WorkingDir
  SetWorkingDir Dir
  contents := ""
  Loop Files, "*", "D" {
    If SubStr(A_LoopFileName, 1, 1) != "_" {
      minifest := A_LoopFilePath "\" . DirToManifest(A_LoopFilePath)
      contents .= "#include " . minifest "`n"
    }
  }
  SetWorkingDir OldDir
  WriteAutoGen(Dir, FileName, contents)
}

WriteAutoGen(Dir, FileName, Contents) {
  FilePath := Dir "\" . FileName
  If FileExist(FilePath)
    FileDelete FilePath ; make room to populate the file
  FileAppend "; THIS FILE WAS AUTO-GENERATED BY 'PluginTree.ahk'.`n", FilePath
  FileAppend "  `; MANUAL CHANGES MAY BE OVERWRITTEN `n`n", FilePath
  FileAppend "#Requires AutoHotkey v2.0`n`n", FilePath
  FileAppend contents, FilePath
  FileAppend "`n#HotIf", FilePath
}

DirToManifest(Dir, FileName := "") {
  if not FileName {
    SplitPath(Dir, &FileName)
    FileName := StrLower(FileName) ".ahk"
  }
  return "_" . FileName
}